<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pknow Your Memes</title>
  <meta name="description" content="A minimal single-file HTML timeline showcasing the origin and evolution of Philippine memes from 2010 to 2025." />
  <style>
    #tagNav button {
  text-transform: capitalize;
}
    :root{
      --bg:#9acadd; --card:#dfdfdfee; --accent:#123f72; --muted:#000000; --maxw:1100px;
      --radius:10px; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
    }
    /* Dark theme variables (toggle by adding .dark on <html>) */
  :root.dark {
    --bg: #0b0f14;
    --card: #292b30;
    --accent:   #34588d;
    --muted: #7b858f;
    --maxw:1100px;
    --text: #b6babe;
    --muted-contrast: #3d5a0f;
  }

  :root.dark body{
    margin:0;
    background:var(--bg);
    color:#f5f9ff;
    display:flex;
    align-items:center;            /* vertically center */
    justify-content:center;       /* horizontally center */
    min-height:100vh;             /* full viewport height so centering works */
    padding:28px;
  }
  :root.dark .year-btn {
    background: #1e1e1e;
    color: #ddd;
    border-color: #333;
  }
  /* === Base vote button styling === */
.vote-box button {
  transition: transform 0.12s ease,
              box-shadow 0.12s ease,
              filter 0.12s ease;
  border-radius: 50%;
}

/* ===== UPVOTE (first button) ===== */
.vote-box button:first-child:hover {
  transform: scale(1.12);
  filter: brightness(1.2);
  box-shadow: 0 0 12px rgba(5, 148, 29, 0.9); /* GREEN glow */
}

.modal-content.has-portrait-video {
  display: flex;
  flex-direction: column;
}

.modal-content.has-portrait-video .vote-box {
  margin-top: auto;  /* pushes it to the bottom */
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

/* ===== DOWNVOTE (last button) ===== */
.vote-box button:last-child:hover {
  transform: scale(1.12);
  filter: brightness(1.2);
  box-shadow: 0 0 12px rgba(255, 60, 60, 0.9); /* RED glow */
}

/* ===== CLICK / PRESS GLOWS ===== */
.vote-box button:first-child.pressed {
  box-shadow: 0 0 16px rgba(5, 148, 29, 0.9);
}

.vote-box button:last-child.pressed {
  box-shadow: 0 0 16px rgba(255, 60, 60, 1);
}

.modal-card { position: relative; } /* make modal-card the positioned ancestor */

.close {
  position: absolute;
  top: 12px;
  right: 12px;
  z-index: 20;
  background: none;
  border: none;
  color: var(--text);
  font-size: 18px;
  cursor: pointer;
  padding: 6px 10px;
  border-radius: 6px;
}

.close:hover { background: rgba(0,0,0,0.06); }

   
  :root.dark .year-btn.active {
    background: #465575;
    color: rgb(0, 0, 0);
    border-color: #0b5cff;
  }
  </style>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, doc, setDoc, updateDoc, onSnapshot, increment, getDoc }
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAweWQoux3ukKP2QxuRM81ObYcnX4wVQtc",
    authDomain: "pknowyourmemes-3b18a.firebaseapp.com",
    projectId: "pknowyourmemes-3b18a",
    storageBucket: "pknowyourmemes-3b18a.firebasestorage.app",
    messagingSenderId: "249296416918",
    appId: "1:249296416918:web:d4c0f67955450a3c0c12b7",
    measurementId: "G-JDB0EFZ01G"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);

  // Initialize Firestore
  const db = getFirestore(app);

  // --- MAKE VOTE() WORK ---
  window.vote = async function(btn, value) {
    const box = btn.parentElement;
    if (!box || !box.classList.contains('vote-box')) {
      console.error('Vote: Could not find vote-box parent');
      return;
    }
    
    const id = box.dataset.id;
    if (!id || id.trim() === '') {
      console.error('Vote: No data-id found');
      return;
    }
    
    // Add pressed class for glow feedback immediately
    try {
      btn.classList.add('pressed');
    } catch (e) {}

    const ref = doc(db, "votes", id);

    try {
      // Ensure document exists
      const docSnap = await getDoc(ref);
      if (!docSnap.exists()) {
        await setDoc(ref, { score: 0 });
      }

      // Apply increment
      await updateDoc(ref, {
        score: increment(value)
      });
    } catch (err) {
      console.error('Vote error', err);
    } finally {
      // Remove pressed state after short delay so glow is visible
      setTimeout(() => {
        try { btn.classList.remove('pressed'); } catch (e) {}
      }, 350);
    }
  };

  // --- LIVE UPDATE ---
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".vote-box").forEach(box => {
      const id = box.dataset.id;
      if (id && id.trim() !== '') {
        const ref = doc(db, "votes", id);
        onSnapshot(ref, snap => {
          box.querySelector(".score").textContent =
            snap.exists() ? snap.data().score : 0;
        });
      }
    });
  });

  // ✅ Stable pattern for modal vote box listener
  let unsubscribeModalVote = null;

  window.attachVoteListener = async function(voteBox) {
    if (!voteBox) return;
    const id = voteBox.dataset.id;
    if (!id || id.trim() === '') return;
    
    const ref = doc(db, "votes", id);
    const scoreEl = voteBox.querySelector(".score");
    
    // ✅ Kill old listener before creating a new one
    if (unsubscribeModalVote) {
      unsubscribeModalVote();
      unsubscribeModalVote = null;
    }
    
    // ✅ Fetch current score immediately to prevent flicker
    try {
      const snap = await getDoc(ref);
      if (scoreEl) {
        const currentScore = snap.exists() && snap.data().score !== undefined 
          ? snap.data().score 
          : 0;
        scoreEl.textContent = currentScore;
      }
    } catch (error) {
      console.error('Error fetching vote score:', error);
      if (scoreEl) {
        scoreEl.textContent = 0;
      }
    }
    
    // ✅ Then set up real-time listener to keep score in sync with database
    unsubscribeModalVote = onSnapshot(ref, snap => {
      if (scoreEl) {
        const currentScore = snap.exists() && snap.data().score !== undefined 
          ? snap.data().score 
          : 0;
        scoreEl.textContent = currentScore;
      }
    }, (error) => {
      console.error('Error in vote listener:', error);
    });
  };
  </script>
  <style>
    html, body { transition: background-color 220ms ease, color 220ms ease; }
    body { color: var(--text, #474242); background: var(--bg); }
    .card { background: var(--card); color: var(--text); border-color: rgba(180, 61, 61, 0.04); }
    .tag, .link-btn, .year-btn.active { background: rgb(223, 225, 230); color: var(--accent); }
    .muted { color: var(--muted-contrast, var(--muted)); }

    /* === Hover glow for vote buttons === */
.vote-box button {
  transition: transform 0.12s ease,
              box-shadow 0.12s ease,
              filter 0.12s ease;
  border-radius: 50%;
}

/* Glow on hover */
.vote-box button:hover {
  transform: scale(1.12);
  filter: brightness(1.2);
  box-shadow: 0 0 10px #bfd0dfbf;
}

/* Stronger glow on press (you already use .pressed in JS) */
.vote-box button.pressed {
  transform: scale(1.18);
  box-shadow: 0 0 14px rgba(255, 215, 0, 0.9);
}



    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#111;display:flex;justify-content:center;padding:28px}
    .wrap{width:100%;max-width:var(--maxw)}

    header{display:flex;align-items:center;gap:16px;margin-bottom:20px;justify-content:space-between}
.logo{width:250x;height:160px;border-radius:12px;object-fit:cover;display:block}
    /* small author photo placed top-right */
    .author-photo {
  width: 60px;           /* smaller width */
  height: 60px;          /* smaller height */
  border-radius: 8px;    /* rounded corners */
  object-fit: cover;     /* keeps proportions */
  flex-shrink: 0;        /* prevents squishing */
  margin-top: 2px;       /* aligns better with text */
}

.author-inline {
  display: flex;
  align-items: flex-start;   /* aligns photo and text at the top */
  gap: 12px;                 /* space between photo and text */
  flex-wrap: wrap;           /* allows text to wrap neatly on smaller screens */
  max-width: 450px;          /* compact width */
}

.author-photo {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  object-fit: cover;
  flex-shrink: 0;            /* prevents photo from shrinking */
}

.author-info {
  flex: 1;
  min-width: 200px;
  word-wrap: break-word;
  line-height: 1.4;
}

.author-bio {
  color: var(--muted);
  font-size: 12px;
  margin: 4px 0;
}

.author-email {
  color: var(--accent);
  text-decoration: none;
  font-weight: 600;
  word-break: break-word;
}
.filter-btn.clear {
  background-color: #e6362a;
  color: rgb(255, 252, 252);
  border: none;
  padding: 8px 12px;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.3s;
}

.filter-btn.clear:hover {
  background-color: #d32f2f;
}

.author-email:hover {
  text-decoration: underline;
}

    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    nav.years{display:flex;flex-wrap:wrap;gap:8px;margin:18px 0}
    .year-btn{background:transparent;border:1px solid #3b798b;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600}
    .year-btn.active{background:var(--accent);color:#ffffff;border-color:var(--accent)}

    .controls{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .search{flex:1}
    input[type=search]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:var(--card);border-radius:var(--radius);padding:12px;border:1px solid #8a8c8d;display:flex;flex-direction:column;gap:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);transition:transform 0.2s}

.thumb-wrapper[data-align="left"] {
  justify-content: flex-start; }

.thumb-wrapper[data-align="right"] {
  justify-content: flex-end;
}

.thumb {
  width: auto; /* allow natural width */
  height: 175px; /* default height */
  object-fit: contain; /* maintain aspect ratio */
  border-radius: 8px;
}

/* ADDED: borders for pictures */
.thumb, .author-photo, .logo {
  border: 3px solid rgba(0,0,0,0.08);
  padding: 4px;
  border-radius: 10px;
  background: rgba(255,255,255,0.6);
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

/* Dark theme override so borders look good on dark background */
:root.dark .thumb,
:root.dark .author-photo,
:root.dark .logo {
  border-color: rgba(255,255,255,0.08);
  background: rgba(0,0,0,0.18);
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}

.meta{display:flex;justify-content:space-between;align-items:center}
    .title{font-weight:700}
    .origin{font-size:12px;color:var(--muted)}
    .tags{display:flex;flex-wrap:wrap;gap:6px}
    .tag{font-size:11px;padding:6px 8px;border-radius:7px;background:#f2f7ff;color:var(--accent)}
    .link-btn{display:inline-block;margin-top:8px;padding:6px 8px;border-radius:7px;background:#f2f7ff;color:var(--accent);text-decoration:none;font-size:12px;border:1px solid rgba(11,92,255,0.08)}
    main{margin-top:10px}
    footer{margin-top:20px;color:var(--muted);font-size:13px}

    /* Modal */
    .modal {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: rgba(0, 0, 0, 0.45);
  z-index: 1000;
}

.modal.open {
  display: flex;
}

.modal-card {
  position: relative;
  background: var(--card);
  border-radius: 12px;
  padding: 24px;
  width: 800px;
  max-width: auto;
  max-height: 800px;
  overflow-y: auto;
}

/* Actions area: placed inline under player, aligned bottom-right */
.modal-actions {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: flex-end; /* push buttons to the right */
  width: 100%;
  margin-top: 12px;          /* space above actions */
  padding-top: 6px;
  box-sizing: border-box;
  border-top: 1px solid rgba(0,0,0,0.04); /* subtle separation */
}

 
 /* Vote box UI */
 .vote-box {
   display: flex;
   align-items: center;
   gap: 6px;
 
   background: var(--card);
   border: 1px solid rgba(0,0,0,0.1);
   border-radius: 10px;
   padding: 6px 10px;
   box-shadow: 0 2px 8px rgba(0,0,0,0.15);
 }
 
 /* Buttons */
 .vote-box button {
   cursor: pointer;
   border: none;
   background: transparent;
   font-size: 18px;
 }
 
 .vote-box .score {
   min-width: 24px;
   text-align: center;
   font-weight: 700;
 }
 
 /* Portrait variant - keep same inline placement */
 .modal-content.has-portrait-video {
   position: relative; /* keep normal flow */
 }
 
 .modal-content.has-portrait-video .vote-box {
   /* same inline layout — no absolute positioning so it sits below the player */
   margin: 10px 0 0 0;
   box-shadow: 0 2px 8px rgba(0,0,0,0.08);
 }
 
 .modal-content {
   display: flex;
   flex-direction: column;
   gap: 16px;
 }
 
 .modal-header {
   margin-bottom: 8px;
 }
 
 .modal-header h2 {
   margin: 0 0 8px 0;
   font-size: 24px;
 }
 
 .modal-desc {
   color: var(--text);
   line-height: 1.5;
 }
 
 #mPlayer {
   display: flex;
   justify-content: center;
   align-items: center;
   width: 100%;
   margin: 16px 0;
 }
 
 #mLinks {
   display: flex;
   flex-wrap: wrap;
   gap: 8px;
   justify-content: flex-start;
   margin-top: 8px;
   margin-bottom: 8px;
 }
 
+.modal-actions .close {
+  background: transparent;
+  border: 1px solid rgba(0,0,0,0.06);
+  padding: 8px 10px;
+  border-radius: 8px;
+  cursor: pointer;
+  font-size: 14px;
+  color: inherit;
+}
 
 .close:hover {
   background: rgba(0,0,0,0.08);
 }
 .close:focus {
   outline: 2px solid var(--accent);
 }
 
 /* Embed container styles */
 .embed-container {
   position: relative;
   width: 100%;
   background: #000;
   border-radius: 8px;
   overflow: hidden;
 }
 
 /* Portrait video */
 .embed-container.portrait {
   width: 200px;
   height: 20px;
 }
 
 /* Landscape video */
 .embed-container.landscape {
   width: 700px;
   height: 400px;
 }

 .embed-container iframe {
   position: absolute;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   border: 0;
 }

  @media (max-width:1000px){
    .modal-grid{grid-template-columns:1fr}
    .modal-thumb{height:200px;max-height:200px}
    .embed-container{min-height:200px}
  }

    /* print-friendly */
    @media print{body{background:#fff} .controls,.year-btn{display:none}}

    /* small helper */
    .muted{color:var(--muted)}


    /* Add to your existing styles */
.embed-container {
  position: relative;
  width: 100%;
  height: 100%;
  min-height: var(--player-height, 320px);
  background: #000;
  border-radius: 8px;
  overflow: hidden;
}

.embed-container iframe,
.embed-container video {
  position: absolute;
  top: 0;
  left: 0;
  width: 100% !important;  /* force full width */
  height: 100% !important; /* force full height */
  border: 0;
}

.modal-grid {
  display: grid;
  gap: 20px;
  grid-template-columns: var(--modal-cols, 320px 1fr);
  align-items: start;
}

/* Ensure right column player fills space */
.right-col .embed-container {
  min-height: var(--modal-player-height, 540px);
}

/* Close player button styles */
.close-player-btn {
  position: absolute;
  bottom: 10px;
  right: 10px;
  padding: 8px 12px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  z-index: 10;
  transition: background 0.2s;
}

.close-player-btn:hover {
  background: rgba(0, 0, 0, 0.9);
}

/* Ensure embed container can position the button */
.embed-container {
  position: relative;
}

/* Video tabs styles - Landscape (tabs on top) */
.video-tabs-container.landscape {
  display: flex;
  flex-direction: column;
}

.video-tabs-container.landscape .video-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 12px;
  flex-wrap: wrap;
  width: 100%;
}

.video-tabs-container.landscape #video-player {
  width: 100%;
  aspect-ratio: 16 / 9;
  border-radius: 12px;
  border: none;
  min-height: 400px;
  display: block;
}

/* Video tabs styles - Portrait (tabs on side) */
.video-tabs-container.portrait {
  display: flex;
  flex-direction: row;
  gap: 12px;
  align-items: flex-start;
}

.video-tabs-container.portrait .video-tabs {
  display: flex;
  flex-direction: column;
  gap: 6px;
  flex-shrink: 0;
  width: auto;
  min-width: 120px;
}

.video-tabs-container.portrait #video-player {
  flex: 1;
  aspect-ratio: 9 / 16;
  max-width: 400px;
  border-radius: 12px;
  border: none;
  min-height: 600px;
  display: block;
}

/* Common tab button styles */
.video-tabs .tab-btn {
  padding: 8px 12px;
  font-size: 13px;
  border: none;
  cursor: pointer;
  border-radius: 6px;
  background: #333;
  color: white;
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
}

.video-tabs .tab-btn:hover {
  background: #555;
}

.video-tabs .tab-btn.active {
  background: var(--accent, #ff4444);
  color: white;
}

/* Ensure proper layout */
#mPlayer {
  display: flex;
  flex-direction: column;
}

  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div style="display:flex;align-items:center;gap:16px">
        <img src="./image/memes.svg" alt="PK Logo" class="logo">
        <div class="brand">
          <h1>Pknow Your Memes</h1>
          <p class="lead">A Website Dedicated to  
            Archiving Filipino Internet Humor, 
                                                            Pop Culture, and Lost Media.</p>
        </div>
      </div>
      <div class="author-inline" aria-labelledby="aboutTitle">
  <img src="./image/theo.jpg" alt="Theo Jan Joseph" class="author-photo" />
  <div class="author-info">
    <div class="author-name" id="aboutTitle">Theo Jan Joseph</div>
    <p class="author-bio">For Fun and Historical Records Timeline</p>
    <p class="author-bio">
      You can email me at tmdanao@up.edu.ph if you want something removed, any corrections, or to contribute.
    </p>
    <p class="author-bio">
  <a href="contributors.html" class="author-email">View Contributors →</a>
  </p>
  </div>
</div>

    </header>

    <div class="controls">
      <div class="search">
        <p class="author-bio">Disclaimer: some data may not be 100% accurate and I would appreciate it if you give me insights.</p>
        <label for="q" class="muted" style="display:none">Search</label>
        <input id="q" type="search" placeholder="Search meme title, tag, or origin" />
    
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="clear" class="year-btn">Show all</button>

        <!-- Filters toggle: reveals years & tags -->
        <button id="filtersToggle" class="year-btn" aria-expanded="false" aria-controls="yearNav tagNav" title="Show filters">Filters ▾</button>

        <button id="darkToggle" class="year-btn" aria-pressed="false" title="Toggle dark mode">Dark</button>
      </div>
    </div>
<div class="filter-controls">
  <button id="clearFilters" class="filter-btn clear">Clear Filters</button>
  <p class="author-bio">
      Remember to Always Clear Filters
</div>

    <nav class="years" aria-label="Filter by year" id="yearNav"></nav>
<nav class="tags" aria-label="Filter by tag" id="tagNav" style="margin-top:10px;"></nav>

    <main>
      <section id="timeline" class="grid" aria-live="polite"></section>
    </main>

    <footer>
      Report dead links or suggest memes to add
    </footer>
  </div>

  <!-- modal: single-column layout (Title → Year/Origin → Description → Player → Link buttons) -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-card" role="document">
    <!-- moved close button below vote box (keeps same id so JS listeners still work) -->
     <div class="modal-content">
       <!-- Title and metadata -->
       <div class="modal-header">
         <h2 id="mTitle"></h2>
         <p class="muted" id="mOrigin"></p>
         <!-- Links container (Source, News, Profile) -->
         <div id="mLinks"></div>
       </div>

      <!-- Description -->
      <div class="modal-desc">
        <p id="mDesc"></p>
      </div>

      <!-- Player container -->
      <div id="mPlayer"></div>
 
      <!-- Tags container (above actions) -->
      <div id="mMetaTop" style="margin-top:10px"></div>
 
      <!-- Actions: vote + close (bottom-right INSIDE modal) -->
      <div class="modal-actions">
        <div class="vote-box" id="modalVoteBox" data-id="">
          <button onclick="vote(this,1)">:)</button>
          <span class="score">0</span>
          <button onclick="vote(this,-1)">:(</button>
        </div>
        <button class="close" id="modalClose" aria-label="Close">✕</button>
      </div>


  <div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_PH/sdk.js#xfbml=1&version=v17.0"></script>

  <script>
    // ====== DATA: add real meme objects here (title, year, origin, image, description, tags)
    // For images, use relative paths or hosted URLs. Keep the page single-file by using base64 if desired.
    const MEMES = [
  {
    title: 'I love you virus',
    year: 2000,
    image: './image/iloveyou.jpg',
    embedUrl: 'https://www.youtube.com/watch?v=tHUi04CwSFk',
    link: 'https://www.cnet.com/tech/services-and-software/history-of-the-iloveyou-virus/',
    news: 'https://www.bbc.com/news/technology-52458765',
    origin: 'Onel de Guzman',
    profile: '',
    description: 'I think it is best to start with Onel De Guzman because he was a major figure for Filipino Internet presence',
    tags: ['news', 'criminal', 'Legend'],

  },
  {
    title: 'Kween Yasmin Peace Sign',
    year: 2023,
    embedUrl: 'https://www.youtube.com/embed/4OIQLxhhVMc?start=25',
    image: './image/kweenyasmin.jpg',
    link: 'https://youtu.be/4OIQLxhhVMc?si=9C6Ro7w1YMrTnahJ&t=25',
    profile: 'https://www.facebook.com/www.facebookyasminasistido.090',
    origin: 'Yasmin Marie M. Asistido',
    description: 'Kween Yasmin nag Pepeace Sign',
    tags:['image','viral','Legend'],
    styles: {
      thumbnail: { },
      
    }
  },
  {
    title: 'Komikero',
    year: 2009,
    embedUrl: 'https://www.youtube.com/embed/bhuYIr1J1zc',
    image: './image/komikero.webp',
    link: 'https://www.youtube.com/watch?si=1rUlyHi4dUW9nsBh&v=bhuYIr1J1zc&feature=youtu.be',
    profile: 'https://en.wikipedia.org/wiki/Gerry_Alanguilan',
    origin: 'Doroteo Gerardo N. Alanguilan Jr.',
    description: 'Hey Baby, meron akong museum sa San Pablo, Laguna. Punta ka!',
    tags: ['ancient','image'],  
    styles: {
      thumbnail: { },
    },
  },
    {
    title: 'Justin Nabunturan',
    year: 2025,
    image: './image/justin.jpeg',
    more2: 'https://www.tiktok.com/@apolinario_29/video/7549381313896172808?q=Justin%20nabunturan%20pogi&t=1762764067911',
    news: 'https://www.facebook.com/share/p/1MSjx7x6TP/',
    link: 'https://www.tiktok.com/@nabunturan69/video/7558041789949611282?_r=1&_t=ZS-910uxG1zKFw',
    origin: 'Lester Bohol',
    profile: 'https://www.facebook.com/profile.php?id=61580183191602',
    description: 'dawg Ricardo Milos long lost son',
    tags: ['tiktok', 'image'],
    styles: {
      player: {
        width: '400px',        
        maxWidth: '400px',     
        height: '600px',       
        margin: '0 auto',      
        display: 'block'
      },
      modal: {
        width: '600px',        
        maxHeight: '80vh',     
        columnRatio: '0/1',    
        playerHeight: '50px'  
      }
    },
  },
  {
  title: 'Kami ang ma pabebe girls',
  year: 2015,
  image: './image/',
  embedurl: 'https://youtu.be/X9YnPhYdpnQ?si=mBYFyKt3Z_kF1sri',
  more1: 'https://www.facebook.com/reel/1177077070956851/?fs=e&fs=e',
  more2: 'https://youtu.be/SOO5M8lCVTQ?si=Gf8ufmOF_8E0yA3B',
  more3: 'https://youtu.be/2kAVERtDMM0?si=G5PsQtGMeldDufYf',
  more4: 'https://youtu.be/E5r12-0ZGoU?si=usKZOE4qGT5b9d3_',
  origin: 'Vhellpoe Galves',
  profile: '',
  description: '',
  tags: ['classical', 'viral']
},
{
    title: 'Kap Nino',
    year: 2021,
    image: './image/kap.jpg',
    more2: 'https://www.tiktok.com/@rxssyyy/video/7441034846325050679?_r=1&_t=ZS-910uR2v8lQz',
    more1: 'https://youtu.be/bwutxPWw6f4?si=h8qHYIPu51H5UcUh',
    origin: 'Nino Barzaga',
    profile: 'https://www.tiktok.com/@soulcaz?_r=1&_t=ZS-910uWCWKUFQ',
    more1:'https://www.facebook.com/groups/1236364274722632',
    description: 'RIP Kap',
    tags: ['mura'],
    styles: {
      player: {
        width: '400px',        
        maxWidth: '400px',     
        height: '600px',       
        margin: '0 auto',      
        display: 'block'
      },
      modal: {
        width: '600px',        
        maxHeight: '80vh',     
        columnRatio: '0/1',    
        playerHeight: '50px'  
      }
    }
  },
  { title:'Wooooooooow so Refreshing', 
year:2014, 
image:'./image/refresh.png', 
link:'https://www.youtube.com/shorts/Tc9LGwTR4kA', 
more1: 'https://youtu.be/8tY7uFL_1Ek?si=NFDu82X1EGy8HYMf&t=87', 
description: 'Yung origin ng sound na to ay galing sa Wow Mali',
origin:'Wow Mali', 
profile:'', 
description:'', 
tags:['sound','classical'], 
  styles: {
  thumbnail: {
    width: 'autopx',
    height: '200px',
    objectFit: 'center',
  objectPosition: 'center' 
   },
  player: {
        width: '400px',        
        maxWidth: '400px',     
        height: '600px',      
        margin: '0 auto',      
        display: 'block'
      },
      modal: {
        width: '600px',        
        maxHeight: '80vh',    
        columnRatio: '0/1',    
        playerHeight: '50px'  
  },
}
},
  {
    title: 'Kapeng matapang',
    year: 2019,
    image: './image/Kapengmatapang.jpg',
    link: 'https://www.facebook.com/reel/1383634471776415',
    profile: 'https://www.facebook.com/reniebhoycjovellanos.jovellanos',
    origin: 'Renie Bhoy Jovellano',
    description: 'Pabili nga po Kapeng Matapang, kapeng matapang, na kaya kang ipaglaban. Aeouaueoueu',
    tags: ['viral', 'urban legend'],
    styles: {
  thumbnail: {
    width: 'autopx',
    height: '175px',
    objectFit: 'center',
  objectPosition: 'center' 
   },
  player: {
    width: '360px',        
    maxWidth: '360px',    
    height: '600px',        
    margin: '0 auto',       
    display: 'block'
  },
  modal: {
    width: '400px',         
    maxHeight: '90vh',      
    columnRatio: '0/1',    
    playerHeight: '600px'   
  },
}
},
  {
    title: 'Friendzone Logo',
    year: 2016,
    embedUrl: 'https://www.youtube.com/embed/0cT78evUJbQ',
    image: './image/friendzone.jpg',
    link: 'https://www.bbc.com/news/blogs-trending-37363350',
    profile: 'httpsyoutu.be/0cT78evUJbQ?si=Ggc-jDfqK081yJFS',
    origin: 'Heart and Like',
    description: 'Friendzone logo meme — origin and context',
    tags: ['image', 'term'],
    styles: {
  thumbnail: {
    width: 'auto',
    height: '175px', 
    objectFit: 'center',
    objectPosition: 'center'
  }
}
  },
  {
    title: 'Caloocan Boy',
    year: 2021,
    embedUrl: 'https://www.youtube.com/watch?v=6FRdPlYtbV4',
    image: './image/caloocanboy.jpg',
    link: 'https://www.facebook.com/photo/?fbid=101011348779108&set=pcb.101011408779102',
    profile: 'https://www.tiktok.com/@benjiepader29',
    song: 'https://www.youtube.com/watch?v=DUmcisXhahQ&list=RDDUmcisXhahQ&start_radio=1',
    origin: 'Benjie Mallillin Pader',
    description: 'Eh Paano kung',
    tags: ['urban legend'], 
    
  },
  {
    title: 'Harry Roque Boracay',
    year: 2020,
    embedUrl: 'https://www.youtube.com/embed/ganSYJCOVrM?start=12',
    image: './image/harryroque.png',
    link: 'https://youtu.be/ganSYJCOVrM?si=x1TpaXdW_W_J-upZ&t=12',
    origin: 'Boracay',
    description: 'Harry Roque served as a spokesperson of Rodrigo Dutwink Boy',
    tags: ['politics'],
    styles: {
  thumbnail: {
    width: 'auto',
    height: '175px', 
    objectFit: 'center',
    objectPosition: 'center'}}
  },
  {
    title: 'Zoom Call Vico Sotto',
    year: 2020,
    news: 'https://inquirersuper.com.ph/trending/someones-thirst-trap-zoom-background-interrupted-a-forum-with-mayor-vico-sotto-and-it-was-hilarious/',
    video: '<iframe width="560" height="315" src="https://www.youtube.com/embed/RBqFPn6Hi1A?si=skOkAVKnKpNdLqLa&amp;start=3" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>',
    image: './image/vicosotto.jpg',
    origin: 'Vico Sotto',
    description: 'Zoom call interrupted by a humorous background during Mayor Vico Sotto’s forum',
    tags: ['politics'],
    styles: {
  thumbnail: {
    width: 'auto',
    height: '175px', 
    objectFit: 'center',
    objectPosition: 'center'
  },
 
}
  },
  {
    title: 'Astig Cap and Super Lola',
    year: 2025,
    news: 'https://www.rappler.com/entertainment/celebrities/dennis-padilla-posts-daughter-claudia-wedding/',
    video: 'https://www.tiktok.com/@celebriteaph/video/7492268626762927368?is_from_webapp=1&sender_device=pc',
    image: './image/dennis.png',
    origin: 'Dennis Padilla',
    description: 'Hangkulet',
    tags: ['celebrity'],
      styles: {
        player: {
        width: '400px',        
        maxWidth: '400px',     
        height: '600px',       
        margin: '0 auto',      
        display: 'block'
      },
      modal: {
        width: '600px',        
        maxHeight: '80vh',     
        columnRatio: '0/1',    
        playerHeight: '500px'  
      }
    }
      },
  {
  title: 'Batang nahulog sa kanal',
  year: 2000,
  image: './image/kanal.jpg',
  link: '',
  origin: '',
  picture: './image/kanal.jpg',
  profile: 'Unknown',
  description: 'No Info Available',
  tags: ['classical', 'image'],
  styles: {
  thumbnail: {
    width: 'auto',
    height: '175px', 
    objectFit: 'center',
    objectPosition: 'center'          
  },
  },},
  {
    title: 'Cringe Covid Dance',
    year: 2020,
    news: 'https://www.esquiremag.ph/politics/news/covid-dance-number-mascot-a00293-20200817',
    video: 'https://youtu.be/ohFruCubxs0?si=zckxpaMAALoZYA9O&t=70',
    embedUrl: 'https://www.youtube.com/embed/ohFruCubxs0?start=70',
    image: './image/Coviddance.png',
    origin: '',
    description: 'Corona Lumayo ka! Di ka namin lalapitan! Medjo lalayo sa kapwa!',
    tags: ['politics', 'dance'],
    styles: {
  thumbnail: {
    width: 'auto',
    height: '0x', 
    objectFit: 'center',
    objectPosition: 'center'
  },
 
}
  },
  {
    title: 'Milktea Burger tsaka Fries',
    year: 2020,
    embedUrl: 'https://www.facebook.com/watch/?v=239443514191792',
    image: './image/Burgermilktea.jpg',
    link: 'https://www.facebook.com/watch/?v=239443514191792',
    profile: 'https://www.tiktok.com/@joretinoy?lang=en',
    origin: '@queenlinaloudaot',
    description: 'Sana all Sinusuyo',
    tags: ['tiktok', 'urban legend'],styles: {
      tthumbnail: {
    width: 'autopx',
    height: '200px',
    objectFit: 'center',
  objectPosition: 'center' 
      },
  player: {
        width: '400px',        
        maxWidth: '400px',     
        height: '600px',       
        margin: '0 auto',      
        display: 'block'
      },
      modal: {
        width: '600px',        
        maxHeight: '80vh',     
        columnRatio: '0/1',    
        playerHeight: '500px'  
      }
    }
  },
  {
    title: 'Binay Memes',
    year: 2016,
    embedUrl: '',
    image: './image/binay.jpg',
    news: 'https://www.pep.ph/news/12/jejomar-binay-reacts-to-ash-wednesday-memes-part-of-the-job-e',
    origin: 'Jejomar Binay',
    description: 'Jejomar "Jojo" Cabauatan Binay Sr. is a Filipino lawyer and politician who served as the 13th Vice President of the Philippines from 2010 to 2016.',
    tags: ['politics'],
    styles: {
  thumbnail: {
    width: 'auto',
    height: '175px', 
    objectFit: 'center',
    objectPosition: 'center'
  },
}
  }
    ];



// Default landscape style (applies when a meme doesn't provide its own player styles)
const landscapeStyle = {
  thumbnail: {
    width: 'auto',
    height: '200px',
    objectFit: 'center',
    objectPosition: 'center'
  },
  player: {
    width: '700px',
    maxWidth: '100%',
    height: '400px',
    margin: '0 auto',
    display: 'block'
  },
  modal: {
    width: '800px',
    maxHeight: '90vh',
    columnRatio: '0/1',
    playerHeight: '400px'
  },
  
};

// And update the portraitStyle object for vertical videos
const portraitStyle = {
  thumbnail: {
    width: 'auto',
    height: '200px',
    objectFit: 'center',
    objectPosition: 'center'},
  player: {
        width: '400px',        // fixed width for vertical videos
        maxWidth: '400px',     // ensures consistent size
        height: '600px',       // tall 9:16 fit
        margin: '0 auto',      // centers the player
        display: 'block'
      },
      modal: {
        width: '600px',        // slightly wider modal
        maxHeight: '80vh',     // prevents overflow
        columnRatio: '0/1',    // full width for player
        playerHeight: '50px'  // matches player height
      }
};

    function createYouTubePlayer(videoId, container) {
  if (!window.YT) {
    // Load YouTube API if not already loaded
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  }

  return new YT.Player(container, {
    height: '315',
    width: '100%',
    videoId: videoId,
    playerVars: {
      autoplay: 1,
      modestbranding: 1,
      rel: 0
    }
  });
}

    const YEARS = [];
    for(let y=1999;y<=2025;y++) YEARS.push(y);

    const el = {
      yearNav:document.getElementById('yearNav'),
      timeline:document.getElementById('timeline'),
      q:document.getElementById('q'),
      clear:document.getElementById('clear'),
      modal:document.getElementById('modal'),
      modalClose:document.getElementById('modalClose'),
      mTitle:document.getElementById('mTitle'),
      mOrigin:document.getElementById('mOrigin'),
      mDesc:document.getElementById('mDesc'),
      mImg:document.getElementById('mImg'),
      mMetaTop:document.getElementById('mMetaTop'), // changed
      mPlayer:document.getElementById('mPlayer'),
      mLinks: null // will be wired after modal DOM replacement
    };

    let activeYear = null;

    function renderYears(){
      el.yearNav.innerHTML = '';
      YEARS.forEach(y=>{
        const btn = document.createElement('button');
        btn.textContent = y;
        btn.className = 'year-btn';
        btn.addEventListener('click',()=>{ setYearFilter(y,btn); });
        el.yearNav.appendChild(btn);
      });
    }

    function setYearFilter(y,btn){
      activeYear = y;
      document.querySelectorAll('.year-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderTimeline();
    }

    function clearYear(){
      activeYear = null;
      document.querySelectorAll('.year-btn').forEach(b=>b.classList.remove('active'));
      renderTimeline();
    }

    function createCard(m) {
      const c = document.createElement('article');
      c.className = 'card';
      c.tabIndex = 0;
      
      // Apply custom card styles if defined
      if (m.styles?.card) {
        Object.assign(c.style, m.styles.card);
      }

      const img = document.createElement('img');
      img.className = 'thumb';
      img.loading = 'lazy';
      img.src = m.image;
      img.alt = m.title;
      
      // Apply custom thumbnail styles including alignment
      if (m.styles?.thumbnail) {
        Object.assign(img.style, m.styles.thumbnail);
        if (m.styles.thumbnail.objectPosition) {
          img.setAttribute('data-align', m.styles.thumbnail.objectPosition);
        }
      }

      const t = document.createElement('div');
      t.innerHTML = `<div class="meta"><div>
          <div class="title">${escapeHtml(m.title)}</div>
          <div class="origin">${m.year} · ${escapeHtml(m.origin)}</div>
        </div></div>`;

  // Only show image + title/year/origin on the card.
  c.appendChild(img);
  c.appendChild(t);

  // Keep modal opening behavior intact
  c.addEventListener('click',()=>openModal(m));
  c.addEventListener('keydown',(e)=>{ if(e.key==='Enter') openModal(m); });
  return c;
    }

    function renderTimeline(){
      const q = el.q.value.trim().toLowerCase();
      const list = MEMES.filter(m=>{
        if (activeYear && m.year !== activeYear) return false;
if (activeTag && !(m.tags || []).includes(activeTag)) return false;
        if(!q) return true;
        const hay = (m.title+' '+m.origin+' '+(m.tags||[]).join(' ')+ ' ' + m.description).toLowerCase();
        return hay.includes(q);
      });
      el.timeline.innerHTML = '';
      if(list.length===0){ el.timeline.innerHTML = '<p class="muted">No memes found — try clearing filters or add entries to the data array.</p>'; return }
      list.forEach(m=> el.timeline.appendChild(createCard(m)) );
    }

    // add helper to reliably render Facebook embeds (retry XFBML.parse then fallback to plugins iframe)
function renderFacebookEmbed(container, fbUrl, playerStyle = {}) {
  if (!fbUrl || !container) return;
  container.innerHTML = '';

  // Check if this is a Reel to apply portrait styling
  const isReel = /facebook\.com.*\/reel\//.test(fbUrl);
  const style = isReel ? portraitStyle.player : playerStyle;

  const wrapper = document.createElement('div');
  wrapper.className = 'embed-container';

  // Apply styles directly to wrapper
  wrapper.style.width = style.width || '100%';
  wrapper.style.maxWidth = style.maxWidth || '960px';
  wrapper.style.height = style.height || '400px';
  wrapper.style.margin = '0 auto';

  const encoded = encodeURIComponent(fbUrl);
  const iframe = document.createElement('iframe');
  iframe.src = `https://www.facebook.com/plugins/video.php?href=${encoded}&show_text=false&autoplay=true&mute=0`;
  iframe.style.width = '100%';
  iframe.style.height = '100%';
  iframe.style.border = '0';
  iframe.allow = 'autoplay; encrypted-media; picture-in-picture';
  iframe.allowFullscreen = true;

  wrapper.appendChild(iframe);
  container.appendChild(wrapper);

  // Update modal width for Reels
  if (isReel) {
    const modalCard = container.closest('.modal-card');
    if (modalCard) {
      modalCard.style.width = portraitStyle.modal.width;
    }
  }
}

// Tab switching function
function switchTab(tab) {
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.tab === tab);
  });
  document.querySelectorAll(".tab-panel").forEach(panel => {
    panel.classList.toggle("active", panel.id === `tab-${tab}`);
  });
}

// Convert YouTube links to embed format
function toEmbed(url) {
  if (!url) return '';
  let embedUrl = url;
  
  // Convert youtube.com/watch?v= to embed format
  embedUrl = embedUrl.replace(/youtube\.com\/watch\?v=/, "youtube.com/embed/");
  
  // Convert youtu.be/ to embed format
  embedUrl = embedUrl.replace(/youtu\.be\//, "youtube.com/embed/");
  
  // If it's already an embed URL, use it as-is
  if (embedUrl.includes('youtube.com/embed/')) {
    // Preserve query parameters (like ?start=25)
    const urlObj = new URL(embedUrl);
    return urlObj.href;
  }
  
  return embedUrl;
}

// Convert YouTube/Facebook/TikTok links to embed format
function convertToEmbed(url) {
  if (!url) return '';
  
  // YouTube
  if (url.includes("youtu.be") || url.includes("youtube.com")) {
    let videoId = '';
    if (url.includes("youtu.be")) {
      videoId = url.split("/").pop().split("?")[0];
    } else if (url.includes("youtube.com/embed/")) {
      // Already an embed URL, extract ID
      videoId = url.split("embed/")[1].split("?")[0];
    } else {
      // youtube.com/watch?v= format
      const match = url.match(/(?:youtube\.com\/watch\?v=|youtube\.com\/embed\/)([A-Za-z0-9_-]{11})/);
      if (match) videoId = match[1];
    }
    
    if (videoId) {
      // Preserve query parameters if they exist
      const urlObj = new URL(url);
      const params = new URLSearchParams(urlObj.search);
      const embedUrl = `https://www.youtube.com/embed/${videoId}`;
      if (params.toString()) {
        return `${embedUrl}?${params.toString()}`;
      }
      return embedUrl;
    }
  }
  
  // TikTok - extract video ID and convert to embed format
  if (url.includes("tiktok.com")) {
    const tt = url.match(/tiktok\.com\/.*\/video\/(\d+)/i);
    if (tt && tt[1]) {
      return `https://www.tiktok.com/embed/v2/${tt[1]}?muted=0`;
    }
    // If it's already an embed URL, return as-is
    if (url.includes("tiktok.com/embed")) {
      return url;
    }
  }
  
  // Facebook reels/video
  if (url.includes("facebook.com")) {
    return "https://www.facebook.com/plugins/video.php?href=" + encodeURIComponent(url);
  }
  
  // Fallback - return as-is
  return url;
}

// Detect if video is portrait orientation
function isPortraitVideo(url) {
  if (!url) return false;
  // TikTok, Facebook Reels, YouTube Shorts are typically portrait
  return /tiktok\.com|facebook\.com.*\/reel|shorts\/|vertical/i.test(url);
}

// Build video tabs dynamically from embedurl/link and more1-more9
function buildVideoTabs(meme) {
  const tabsContainer = document.getElementById("video-tabs");
  const player = document.getElementById("video-player");
  const container = tabsContainer?.parentElement;
  
  if (!tabsContainer || !player || !container) return;
  
  tabsContainer.innerHTML = "";
  
  // Collect all possible video fields
  const links = [];
  const linkLabels = [];
  
  // Check for embedurl or link (main video)
  const mainVideo = meme.embedurl || meme.link || meme.video;
  if (mainVideo) {
    links.push(mainVideo);
    linkLabels.push("Video 1");
  }
  
  // Check for more1 through more9
  for (let i = 1; i <= 9; i++) {
    const key = `more${i}`;
    if (meme[key] && meme[key].trim() !== '') {
      links.push(meme[key]);
      linkLabels.push(`Video ${links.length}`);
    }
  }
  
  // No videos found
  if (!links.length) {
    player.style.display = "none";
    return;
  }
  
  player.style.display = "block";
  
  // Detect orientation from first video (or check if majority are portrait)
  let portraitCount = 0;
  links.forEach(link => {
    if (isPortraitVideo(link)) portraitCount++;
  });
  const isPortrait = portraitCount > links.length / 2; // If majority are portrait, use portrait layout
  
  // Apply orientation class to container
  container.classList.remove("landscape", "portrait");
  container.classList.add(isPortrait ? "portrait" : "landscape");
  
  // Also add class to modal-content for vote box positioning
  const modalContent = document.querySelector('.modal-content');
  if (modalContent) {
    modalContent.classList.remove("has-portrait-video");
    if (isPortrait) {
      modalContent.classList.add("has-portrait-video");
    }
  }
  
  // Convert first video to embed and autoplay it
  player.src = convertToEmbed(links[0]);
  
  // Build tabs
  links.forEach((link, index) => {
    const btn = document.createElement("button");
    btn.className = "tab-btn";
    btn.textContent = linkLabels[index];
    if (index === 0) btn.classList.add("active");
    
    btn.onclick = () => {
      player.src = convertToEmbed(link);
      document.querySelectorAll(".video-tabs .tab-btn")
        .forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      
      // Update orientation if needed when switching videos
      const newIsPortrait = isPortraitVideo(link);
      const oldIsPortrait = container.classList.contains("portrait");
      
      if (newIsPortrait !== oldIsPortrait) {
        container.classList.remove("landscape", "portrait");
        container.classList.add(newIsPortrait ? "portrait" : "landscape");
        
        // ADDED: Also update modal-content class for vote box positioning
        if (modalContent) {
          modalContent.classList.remove("has-portrait-video");
          if (newIsPortrait) {
            modalContent.classList.add("has-portrait-video");
          }
        }
        
        // ADDED: Update modal card width to match orientation
        const modalCard = document.querySelector('.modal-card');
        if (modalCard) {
          if (newIsPortrait) {
            modalCard.style.width = portraitStyle.modal.width;
          } else {
            modalCard.style.width = landscapeStyle.modal.width;
          }
        }
      }
    };
    
    tabsContainer.appendChild(btn);
  });
}

// Updated openModal to follow vertical layout, and to populate links into #mLinks
function openModal(m) {
  el.mTitle.textContent = m.title || '';
  el.mOrigin.textContent = (m.year || '') + (m.origin ? ' · ' + m.origin : '');
  el.mDesc.textContent = m.description || '';
  if (el.mImg) el.mImg.src = m.image || '';

  el.mMetaTop.innerHTML = '';
  el.mPlayer.innerHTML = '';
  el.mLinks = document.getElementById('mLinks');
  if (el.mLinks) el.mLinks.innerHTML = '';
  
  // Set unique vote box ID for this meme and set up listener (do this for all modals)
  const voteBox = document.getElementById('modalVoteBox');
  if (voteBox) {
    // Create a unique ID from title and year (sanitized for use as data-id)
    const uniqueId = 'modal_' + (m.title || 'meme').replace(/[^a-zA-Z0-9]/g, '_').toLowerCase() + '_' + (m.year || 'unknown');
    voteBox.setAttribute('data-id', uniqueId);
    
    // ✅ Attach fresh listener for this meme (fetches score immediately to prevent flicker)
    if (window.attachVoteListener) {
      window.attachVoteListener(voteBox);
    } else {
      console.error('attachVoteListener is not available');
    }
  }
  
  // Check if there are multiple videos (embedurl/link + any more1-more9)
  const mainVideo = m.embedurl || m.link || m.video;
  const hasMoreVideos = mainVideo || (m.more1 && m.more1.trim() !== '') || 
                        (m.more2 && m.more2.trim() !== '') || 
                        (m.more3 && m.more3.trim() !== '');
  
  // If multiple videos exist, use tab system
  if (hasMoreVideos) {
    // Count total videos
    let videoCount = 0;
    if (mainVideo) videoCount++;
    for (let i = 1; i <= 9; i++) {
      if (m[`more${i}`] && m[`more${i}`].trim() !== '') videoCount++;
    }
    
    // Only use tabs if there are 2+ videos
    if (videoCount >= 2) {
      el.mPlayer.innerHTML = `
        <div class="video-tabs-container landscape" id="video-tabs-container">
          <div class="video-tabs" id="video-tabs"></div>
          <iframe id="video-player"
                  width="100%"
                  height="315"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen></iframe>
        </div>
      `;
      
      // Build tabs and load videos
      buildVideoTabs(m);
      
      // Render Source, News, Profile buttons (must be done before early return)
      const mainLinks = [];
      if (m.link) mainLinks.push({ href: m.link, text: 'Source' });
      if (m.news) mainLinks.push({ href: m.news, text: 'News' });
      if (m.profile) mainLinks.push({ href: m.profile, text: 'Profile' });

      if (mainLinks.length && el.mLinks) {
        el.mLinks.innerHTML = ''; // Clear any existing content
        const seen = new Set();
        mainLinks.forEach(l => {
          try {
            if (!l.href || !l.href.trim()) return;
            const key = String(l.href).trim();
            if (seen.has(key)) return;
            seen.add(key);
            const a = document.createElement('a');
            a.href = l.href;
            a.className = 'link-btn';
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.textContent = l.text;
            a.addEventListener('click', e => e.stopPropagation());
            el.mLinks.appendChild(a);
          } catch (err) {}
        });
      }
      
      // Show modal and return early (tabs are set up, vote box is already configured)
      el.modal.classList.add('open');
      el.modal.setAttribute('aria-hidden', 'false');
      return; // Exit early, don't render single video
    }
  }


  // Apply modal sizing
  const modalCard = el.modal.querySelector('.modal-card');
  const modalGrid = el.modal.querySelector('.modal-grid');
  if (modalCard) {
    modalCard.style.removeProperty('--modal-max-height');
    modalCard.style.removeProperty('--modal-player-height');
    modalCard.style.removeProperty('--modal-cols');
    modalCard.style.width = '';
  }

  if (m.styles && m.styles.modal && modalCard) {
    const md = m.styles.modal;
    if (md.maxHeight) modalCard.style.setProperty('--modal-max-height', md.maxHeight);
    if (md.playerHeight) modalCard.style.setProperty('--modal-player-height', md.playerHeight);
    if (md.width) modalCard.style.width = md.width;

    if (md.columnRatio) {
      // accept "35/65" or "320px 1fr" or "0/1" etc.
      if (String(md.columnRatio).includes('/')) {
        const parts = String(md.columnRatio).split('/');
        // ensure numeric fallback
        const l = Number(parts[0]) || 0;
        const r = Number(parts[1]) || 1;
        const cols = `${l}fr ${r}fr`;
        modalCard.style.setProperty('--modal-cols', cols);
        if (modalGrid) modalGrid.style.gridTemplateColumns = cols;
      } else {
        // use given CSS value (e.g. "320px 1fr")
        modalCard.style.setProperty('--modal-cols', md.columnRatio);
        if (modalGrid) modalGrid.style.gridTemplateColumns = md.columnRatio;
      }
    }
  }

  // show modal first so embeds can measure correctly
  el.modal.classList.add('open');
  el.modal.setAttribute('aria-hidden', 'false');

  const source = m.embedUrl || m.video || m.link;
  const info = getEmbedInfo(source);

// Detect vertical (portrait) videos automatically
const isPortrait = /tiktok\.com|facebook\.com.*\/reel|shorts\/|vertical/i.test(source || '');
const defaultPlayer = isPortrait ? portraitStyle.player : landscapeStyle.player;

// Add class to modal-content for vote box positioning
const modalContent = document.querySelector('.modal-content');
if (modalContent) {
  modalContent.classList.remove("has-portrait-video");
  if (isPortrait) {
    modalContent.classList.add("has-portrait-video");
  }
}


  // pick default player styles for video embeds when none provided
  const p = Object.assign({}, defaultPlayer, m.styles?.player || {});

  // then use `p` instead of previous p usage:
  // create a player wrapper element that will host the iframe or other embed UI
  const playerWrap = document.createElement('div');
  playerWrap.className = 'embed-container';

  if (p.maxWidth) playerWrap.style.maxWidth = p.maxWidth;
  if (p.width) playerWrap.style.width = p.width;
  if (p.margin) playerWrap.style.margin = p.margin;
  if (p.height) {
    playerWrap.style.minHeight = (/^\d+$/.test(String(p.height)) ? String(p.height) + 'px' : p.height);
    if (modalCard) modalCard.style.setProperty('--modal-player-height', playerWrap.style.minHeight);
  }

  // Render different embed types: video iframe, facebook plugin, image, or fallback link
  if (info && info.type === 'video') {
    const iframe = document.createElement('iframe');
    iframe.src = info.embedUrl;
    iframe.frameBorder = '0';
    iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
    iframe.allowFullscreen = true;
    iframe.style.width = '100%';
    iframe.style.height = '100%';

    playerWrap.appendChild(iframe);
    el.mPlayer.appendChild(playerWrap);

  } else if (info && info.type === 'facebook') {
    // Facebook helper will append its own wrapper
    renderFacebookEmbed(el.mPlayer, info.embedUrl, p);

  } else {
    // If there's no video but there is an image/picture, show it inside the player area
    const picSrc = (m.image && m.image.trim()) ? m.image : (m.picture && m.picture.trim() ? m.picture : null);
    if (picSrc) {
      const img = document.createElement('img');
      img.className = 'embed-photo';
      img.src = picSrc;
      img.alt = m.title || 'Image';
      // ensure image fills the player area while keeping aspect ratio
      img.style.width = '100%';
      img.style.height = 'auto';
      playerWrap.appendChild(img);
      el.mPlayer.appendChild(playerWrap);
    } else if (source) {
      // fallback: show link to the source if no image available
      const linkDiv = document.createElement('div');
      linkDiv.className = 'modal-links';
      const a = document.createElement('a');
      a.href = source;
      a.className = 'link-btn';
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = 'Open Source';
      linkDiv.appendChild(a);
      if (el.mLinks) el.mLinks.appendChild(linkDiv);
      else el.mPlayer.appendChild(linkDiv);
    }
  }

  // render Source, News, Profile buttons right after Year/Origin
  const mainLinks = [];
  if (m.link) mainLinks.push({ href: m.link, text: 'Source' });
  if (m.news) mainLinks.push({ href: m.news, text: 'News' });
  if (m.profile) mainLinks.push({ href: m.profile, text: 'Profile' });

  if (mainLinks.length && el.mLinks) {
    el.mLinks.innerHTML = ''; // Clear any existing content
    const seen = new Set();
    mainLinks.forEach(l => {
      try {
        if (!l.href || !l.href.trim()) return;
        const key = String(l.href).trim();
        if (seen.has(key)) return;
        seen.add(key);
        const a = document.createElement('a');
        a.href = l.href;
        a.className = 'link-btn';
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = l.text;
        a.addEventListener('click', e => e.stopPropagation());
        el.mLinks.appendChild(a);
      } catch (err) {}
    });
  }

  // thumbnail max-height (kept but mImg is hidden by CSS per your previous request)
  if (m.styles?.thumbnail?.height && el.mImg) {
    el.mImg.style.maxHeight = m.styles.thumbnail.height;
  } else if (el.mImg) {
    el.mImg.style.maxHeight = '240px';
  }
}

    // make sure close removes any players inside right column
    function closeModal() {
      el.mPlayer.innerHTML = '';
      
      // ADDED: Reset modal-content classes when closing
      const modalContent = document.querySelector('.modal-content');
      if (modalContent) {
        modalContent.classList.remove("has-portrait-video");
      }
      
      // clear any sizing/class state so next modal opens with its own size
      const modalCard = document.querySelector('.modal-card');
      if (modalCard) {
        modalCard.classList.remove('tabs-open','portrait');
        modalCard.style.width = '';
        modalCard.style.removeProperty('--modal-max-height');
        modalCard.style.removeProperty('--modal-player-height');
        modalCard.style.removeProperty('--modal-cols');
      }

      el.modal.classList.remove('open');
      el.modal.setAttribute('aria-hidden', 'true');
    }

    el.modal.addEventListener('click',(e)=>{ if(e.target === el.modal) closeModal(); });
    el.modalClose.addEventListener('click',closeModal);
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeModal(); });

    el.q.addEventListener('keydown',(e)=>{ if(e.key==='Enter') renderTimeline(); });
    el.clear.addEventListener('click',()=>{ el.q.value=''; clearYear(); });

    // escape HTML for safety (simple)
    function escapeHtml(str){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

// ==== TAG FILTERS ====
const elTagNav = document.getElementById('tagNav');
let activeTag = null;

function getAllTags() {
  const all = new Set();
  MEMES.forEach(m => (m.tags || []).forEach(t => all.add(t)));
  return Array.from(all).sort();
}

function renderTags() {
  elTagNav.innerHTML = '';
  getAllTags().forEach(tag => {
    const btn = document.createElement('button');
    btn.textContent = tag;
    btn.className = 'year-btn'; // reuse button style
    btn.addEventListener('click', () => {
      activeTag = (activeTag === tag ? null : tag);
      document.querySelectorAll('#tagNav .year-btn').forEach(b => b.classList.remove('active'));
      if (activeTag) btn.classList.add('active');
      renderTimeline();
    });
    elTagNav.appendChild(btn);
  });
}

// Clear Filters button logic (kept outside renderTags)
document.addEventListener("DOMContentLoaded", () => {
  const clearFiltersBtn = document.getElementById("clearFilters");
  if (!clearFiltersBtn) return;

  clearFiltersBtn.addEventListener("click", () => {
    activeYear = null;
    activeTag = null;

    // Remove active states from buttons
    document.querySelectorAll(".year-btn, .tag-btn").forEach(btn => {
      btn.classList.remove("active");
    });

    // Refresh UI
    renderTimeline();
    renderTags();
  });
});
    renderTags();
    
    // initial render
    renderYears(); renderTimeline();

    // Dark mode toggle (persists to localStorage)
   const darkBtn = document.getElementById('darkToggle');
   function setDarkMode(enabled){
     try{
       if(enabled){
         document.documentElement.classList.add('dark');
         localStorage.setItem('pk-dark','1');
         if(darkBtn){ darkBtn.textContent = 'Light'; darkBtn.setAttribute('aria-pressed','true'); }
       } else {
         document.documentElement.classList.remove('dark');
         localStorage.removeItem('pk-dark');
         if(darkBtn){ darkBtn.textContent = 'Dark'; darkBtn.setAttribute('aria-pressed','false'); }
       }
     }catch(e){}
   }
   if(darkBtn){
     darkBtn.addEventListener('click', ()=> setDarkMode(!document.documentElement.classList.contains('dark')));
   }
   // initialize from storage
   (function(){ const saved = localStorage.getItem('pk-dark'); setDarkMode(saved === '1'); })();

  // Filters toggle wiring: show/hide year/tag lists
  (function(){
    const btn = document.getElementById('filtersToggle');
    const wrap = document.querySelector('.wrap');
    const clearFiltersBtn = document.getElementById('clearFilters');
    if(!btn || !wrap) return;

    function setOpen(open){
      wrap.classList.toggle('filters-open', !!open);
      btn.classList.toggle('active', !!open);
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      btn.textContent = open ? 'Filters ▴' : 'Filters ▾';
    }

    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      setOpen(!wrap.classList.contains('filters-open'));
    });

    // Close filters when clearing
    if(clearFiltersBtn){
      clearFiltersBtn.addEventListener('click', ()=> setOpen(false));
    }

    // Optional: close when clicking outside the filters area
    document.addEventListener('click', (e)=>{
      if(!wrap.classList.contains('filters-open')) return;
      const inside = wrap.contains(e.target) && (e.target.closest('.years') || e.target.closest('#tagNav') || e.target.closest('#filtersToggle'));
      if(!inside) setOpen(false);
    });
  })();

    // Expose simple helper to add new meme entries from browser console
    window._MemeAdmin = {
      add(m){ MEMES.push(m); renderTimeline(); return m; },
      all(){ return MEMES; }
    };

    // Replace the old getEmbedUrl with this helper that returns {embedUrl, type}
// type === 'video' -> safe to render iframe player
// type === 'link'  -> not a video (just provide link)
// null             -> unknown / unsupported
function getEmbedInfo(url) {
  if (!url) return null;
  const s = String(url).trim();

  try {
    // YouTube (supports watch, embed, youtu.be and shorts)
    const yt = s.match(/(?:youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/|shorts\/)|youtu\.be\/)([A-Za-z0-9_-]{11})/i);
    if (yt && yt[1]) {
      const id = yt[1];
      // preserve and normalize time param 't' -> 'start' (seconds)
      let embedUrl = `https://www.youtube-nocookie.com/embed/${id}`;
      try {
        const u = new URL(s);
        const params = new URLSearchParams(u.search);
        if (params.has('t')) {
          const t = params.get('t');
          const toSeconds = (str) => {
            if (!str) return 0;
            if (/^\d+$/.test(str)) return parseInt(str,10);
            const match = str.match(/(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?/i);
            if (!match) return 0;
            return (parseInt(match[1]||0,10)*3600) + (parseInt(match[2]||0,10)*60) + (parseInt(match[3]||0,10));
          };
          const start = toSeconds(t);
          params.delete('t');
          if (start) params.set('start', String(start));
        }
        const qs = params.toString();
        embedUrl = qs ? `${embedUrl}?${qs}` : `${embedUrl}?autoplay=1&rel=0`;
      } catch(e){
        embedUrl = `${embedUrl}?autoplay=1&rel=0`;
      }
      return { embedUrl, type: 'video' };
    }

    // TikTok - added muted=0 to enable sound
    const tt = s.match(/tiktok\.com\/.*\/video\/(\d+)/i);
    if (tt && tt[1]) {
      return { embedUrl: `https://www.tiktok.com/embed/v2/${tt[1]}?muted=0`, type: 'video' };
    }

    // Facebook (handled in renderFacebookEmbed)
    if (/facebook\.com|fb\.watch/i.test(s)) {
      return { embedUrl: s, type: 'facebook' };
    }

    // Reddit
    if (/reddit\.com|redd\.it/i.test(s)) {
      try {
        const u = new URL(s);
        if (u.pathname.includes('/comments/')) {
          return { embedUrl: `https://www.redditmedia.com${u.pathname}embed`, type: 'video' };
        }
      } catch (e) {}
      return { embedUrl: s, type: 'link' };
    }

    // Vimeo
    const vimeo = s.match(/vimeo\.com\/(?:video\/)?(\d+)/i);
    if (vimeo && vimeo[1]) {
      return { embedUrl: `https://player.vimeo.com/video/${vimeo[1]}`, type: 'video' };
    }

    // Generic http link -> treat as link
    if (/^https?:\/\//i.test(s)) {
      return { embedUrl: s, type: 'link' };
    }
  } catch (err) {
    console.warn('getEmbedInfo parse error', err);
  }
  return null;
}
  </script>
</body>
</html>
