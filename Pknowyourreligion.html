<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Pknow Your Religion ‚Äî Religion and Spiritual Practices in the Philippines</title>
<style>
/* Replace previous body/background rules with color-only defaults (allow JS to set images) */
body {
  margin: 0;
  font-family: Inter, system-ui, sans-serif;
  background:  url("image2/cat3.jpg") no-repeat center center fixed ;
  background-size: contain;
  color: #000 !important;
}

body.dark {
  background: url("image2/night.jpg") no-repeat center center fixed ;
  background-size: contain;
  color: #000000 !important;
  /* JS will set background-image for dark mode */
}
:root, html {
  --card-bg: #000000;
  --modal-bg: #191818;
  --modal-text: #ffffff;
  --card-text: #222;
  --muted: #efeaea;
  color: #322b2b !important;
}
body.dark, html.dark {
  --modal-bg: #222;
  --card-bg: #222;
  --modal-text: #fff;
  --card-text: #fff;
  --muted: #e0e0e0;
  color: #634646 !important;
}
header {
  text-align: center;
  padding: 24px;
}

h1 {
  margin: 0;
  font-size: 40px;
}
p.subtitle {
  opacity: .85;
  font-size: 1.2em;
}
#searchBar {
  display: block;
      width: 100%;
      max-width: 750px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
      margin-bottom: 2px !important;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
      margin: 8px 0;
}
#grid {
  display: flex;
  flex-direction: column;
  gap: 20px;
  align-items: center;
  padding: 20px;
}
.card {
  background: var(--card-bg);
  border-radius: 16px;
  max-width: 820px;
  width: 100%;
  padding: 20px;
  cursor: pointer;
  box-shadow: 0 8px 24px rgba(0,0,0,.7);
  display: flex;
  gap: 20px;
  align-items: flex-start;
  border: 2px solid #444;
  transition: box-shadow 0.2s, border 0.2s;
  color: var(--card-text);
}
.card:hover {
  box-shadow: 0 12px 32px rgba(0,0,0,0.85);
  border: 2px solid #888;
}
.card-img {
  width: 110px;
  height: 110px;
  flex-shrink: 0;
  border-radius: 12px;
  background: #181818;
  object-fit: cover;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  color: #888;
  position: relative;
  overflow: visible;
  border: 2px solid #444;
}
.card-img:hover .img-preview {
  display: block;
}
.img-preview {
  display: none;
  position: absolute;
  z-index: 10;
  top: -10px;
  left: 120px;
  width: 260px;
  height: 260px;
  border-radius: 16px;
  background: #181818;
  box-shadow: 0 8px 32px rgba(0,0,0,0.85);
  border: 2px solid #444;
  padding: 0;
  pointer-events: none;
}
.img-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 16px;
}
.card-content {
  flex: 1;
}
.card h2 {
  margin: 0 0 8px;
  font-size: 22px; /* reduced from 28px */
  font-weight: 700;
  color: #fff;
}
.card small {
  opacity: .8;
  font-size: 1em;
  color: #bbb;
}
.card p {
  line-height: 1.6;
  color: #e0e0e0;
}
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 1;
  pointer-events: none;
}
.modal.open {
  display: flex;
  opacity: 1;
  pointer-events: auto;
}
.modal.closing {
  opacity: 1;
  pointer-events: none;
}
.modal-content {
  background: var(--modal-bg);
  color: var(--modal-text);
  border-radius: 16px;
  width: 650px;
  height: 700px;
  padding: 20px 20px 0 20px;
  display: flex;
  flex-direction: column;
  position: relative;
  box-shadow: 0 12px 48px rgba(0,0,0,0.9);
  border: 2px solid #444;
  font-size: 1em; /* reduced from 1.1em */
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: #444 #222;
}
.modal-content::-webkit-scrollbar {
  width: 8px;
}
.modal-content::-webkit-scrollbar-thumb {
  background: #444;
  border-radius: 8px;
}
.modal-content::-webkit-scrollbar-track {
  background: #222;
  border-radius: 8px;
}
.modal-close {
  position: absolute;
  top: 18px;
  right: 22px;
  font-size: 2em;
  color: #bbb;
  cursor: pointer;
  z-index: 10;
  transition: color 0.2s;
  user-select: none;
}
.modal-close:hover {
  color: #fff;
}
.modal-header {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 24px;
  margin-bottom: 10px;
}
@media (max-width: 700px) {
  .modal-header {
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  .modal-img-box {
    width: 90px;
    height: 90px;
    border-radius: 12px;
  }
  .modal-img-box img {
    border-radius: 12px;
  }
  .modal-header-info {
    align-items: center;
    text-align: center;
  }
}
.modal-img-box {
  position: static;
  margin: 0;
  width: 120px;
  height: 120px;
  border-radius: 16px;
  background: #181818;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  border: 2px solid #444;
  flex-shrink: 0;
  position: relative; /* ensure relative for preview positioning */
}
.modal-img-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 16px;
}
/* Modal image preview styling */
.modal-img-box .img-preview {
  display: none;
  position: absolute;
  z-index: 20;
  top: -10px;
  left: 130px;
  width: 260px;
  height: 260px;
  border-radius: 16px;
  background: #181818;
  box-shadow: 0 8px 32px rgba(0,0,0,0.85);
  border: 2px solid #444;
  padding: 0;
  pointer-events: none;
}
.modal-img-box .img-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 16px;
}
.modal-img-box:hover .img-preview {
  display: block;
}
.modal-header-info {
  flex: 1;
  min-width: 0;
  text-align: left;
  margin-top: 0;
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.modal-title {
  font-size: 1.3em; /* reduced from 2em */
  font-weight: 700;
  color: #fff;
  margin: 0 0 4px 0;
  word-break: break-word;
}
.modal-meta {
  color: #ccc;
  font-size: 1em; /* reduced from 1.1em */
  margin-bottom: 2px;
  font-weight: 500;
}
.modal-meta span {
  display: block;
}
.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
  margin-left: 0px;
}
.tabs button {
  padding: 6px 18px;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  background: #444;
  color: #fff;
  font-size: 1em;
  font-weight: 600;
  transition: background 0.2s, color 0.2s;
}
.tabs button.active {
  background: #fff;
  color: #222;
}
.panel {
  display: none;
  overflow: auto;
  padding: 0 10px 20px 10px;
  color: #fff;
  font-size: 1em; /* reduced from 1.1em */
}
.panel.active {
  display: block;
}
.photo-gallery {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 8px;
  margin-bottom: 60px;
}
.photo-gallery img {
  max-width: 100%;
  height: auto;
  aspect-ratio: 16/9;
  width: min(160px, 100%);
  border-radius: 10px;
  background: #222;
  object-fit: cover;
  flex: 1 1 120px;
  border: 2px solid #444;
}

/* Thumbnails with captions */
.photo-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: min(160px, 100%);
}
.photo-caption {
  color: #ccc;
  font-size: 0.85em;
  margin-top: 4px;
  text-align: center;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.video-gallery {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  margin-top: 8px;
  margin-bottom: 40px;
}
.video-gallery iframe {
  width: 500px;
  height: 300px;
  border-radius: 10px;
  background: #181818;
  border: 2px solid #444;
  flex: 1 1 320px;
  max-width: 100%;
}
@media (max-width: 700px) {
  .modal-content h2,
  .modal-content small,
  .tabs {
    margin-left: 0 !important;
  }
  .modal-img-box {
    position: static;
    margin: 0 auto 16px auto;
    display: block;
    width: 90px;   /* slightly larger for mobile */
    height: 90px;
    border-radius: 12px;
  }
  .modal-img-box img {
    border-radius: 12px;
  }
  .video-gallery iframe {
    width: 100%;
    min-width: 220px;
    height: 300px;
  }
}
.desc-section {
  margin-bottom: 14px; /* slightly reduced */
}
.desc-section h3 {
  margin: 0 0 6px 0;
  font-size: 1em; /* reduced from 1.15em */
  font-weight: 700;
  color: #fff;
}
.desc-section p {
  margin: 0;
  color: #e0e0e0;
  font-size: 0.97em; /* slightly reduced */
  line-height: 1.5;   /* slightly reduced */
}
.modal-img-box {
  position: static;
  margin: 0 auto;
  width: 120px;
  height: 120px;
  border-radius: 16px;
  background: #181818;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  border: 2px solid #444;
}
.modal-img-box img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 16px;
}
.logo {
  width: 750px;
  height: auto;
  margin-bottom: -70px;
}
.index-logo-link {
  position: fixed;
  top: 18px;
  left: 18px;
  z-index: 120;
  display: block;
}
.index-logo-link .main-logo {
  max-width: 120px;
  width: 100%;
  margin: 0;
  transition: transform .2s;
}
.index-logo-link:hover .main-logo {
  transform: scale(1.08);
}
.button,
button,
input[type="button"],
input[type="submit"] {
  display: inline-block;
  padding: 8px 18px;
  border-radius: 8px;
  border: none;
  font-size: 1em;
  font-family: inherit;
  font-weight: 600;
  cursor: pointer;
  background: #444;
  color: #fff;
  transition: background 0.18s, color 0.18s, box-shadow 0.18s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  margin: 0 2px;
}
.button:hover,
button:hover,
input[type="button"]:hover,
input[type="submit"]:hover {
  background: #666;
  color: #fff;
}
.button:active,
button:active,
input[type="button"]:active,
input[type="submit"]:active {
  background: #222;
  color: #fff;
}
.dark-toggle {
  position: fixed;
  right: 20px;
  top: 20px;
  z-index: 200;
}
.disclaimer {
  margin: 35px 0 2px;
  margin-bottom: 50px !important;
  margin-top: -50px;
  margin-left: 150px;
  font-size: 12px;
  color: var(--muted, #000000);
  opacity: 0.85;
  text-align: center;
}
.filter-bar {
  display: flex;
  gap: 10px;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-width: 600px;
  margin-bottom: 8px;
  flex-wrap: wrap;
}
.category-dropdown {
  position: relative;
  min-width: 160px;
}
.category-dropdown-btn {
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid #000000;
  background: #363636;
  color: #fff;
  font-size: 1em;
  cursor: pointer;
  width: 100%;
  text-align: left;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.category-dropdown-btn[aria-expanded="true"] {
  background: #444;
}
.category-dropdown-list {
  display: none;
  position: absolute;
  left: 0;
  top: 110%;
  background: #222;
  color: #fff;
  border: 1px solid #888;
  border-radius: 8px;
  min-width: 160px;
  z-index: 10;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  max-height: 220px;
  overflow-y: auto;
  list-style: none; /* Remove bullets */
  padding-left: 0;  /* Remove default padding */
  margin-left: 0;   /* Move left (remove margin) */
}
.category-dropdown-list.open {
  display: block;
}
.category-dropdown-list li {
  padding: 8px 16px;
  cursor: pointer;
  transition: background 0.15s;
}
.category-dropdown-list li:hover,
.category-dropdown-list li.selected {
  background: #444;
}

/* Clear button styles */
.clear-btn,
#clearBtn {
  padding: 8px 12px;
  background: #ffecec !important;
  color: #b40000 !important;
  border: 1px solid #ffb3b3 !important;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: 0.15s;
  font-weight: 500;
  font-family: Arial, Helvetica, sans-serif !important;
  -webkit-appearance: none;
  appearance: none;
}
.clear-btn:hover,
#clearBtn:hover {
  background: #ffdddd !important;
  border-color: #ff9999 !important;
}

/* Shuffle button styles */
.shuffle-btn {
  padding: 8px 12px;
  background: #eaf1ff;
  color: var(--accent, #035403);
  border: 1px solid #d0dcff;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  transition: 0.15s;
  font-family: Arial, Helvetica, sans-serif;
}
.shuffle-btn:hover {
  background: #d0dcff;
  transform: scale(1.05);
}
.shuffle-btn:active {
  transform: scale(0.95) rotate(180deg);
}

/* Specific instance overrides */
#shuffleBtn {
  background: #b2d2b2;
  color: #035403;
  border: 1px solid #5b8d5b;
}
#shuffleBtn:hover {
  background: #abebab;
  border-color: #144114;
}
@media (max-width: 700px) {
  .filter-bar {
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
  }
  .category-dropdown {
    min-width: 0;
  }
}

/* Minimal styling for References panel */
.references-list {
  margin: 10px 0 24px 0;
  padding-left: 16px;
  color: var(--modal-text);
}
.references-list li {
  margin: 6px 0;
  font-size: 0.98em;
}
.references-list a {
  color: #7cf;
  text-decoration: underline;
}

/* Photo viewer (lightbox) */
.photo-viewer {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}
.photo-viewer.open { display: flex; }
.photo-viewer-content {
  position: relative;
  max-width: 92vw;
  max-height: 88vh;
}
.photo-viewer-img {
  max-width: 900px;
  max-height: 500px;
  border-radius: 10px;
  box-shadow: 0 12px 48px rgba(0,0,0,0.7);
  background: #111;
}
.photo-viewer-close,
.photo-viewer-prev,
.photo-viewer-next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  border: none;
  background: rgba(255,255,255,0.12);
  color: #fff;
  padding: 10px 14px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 18px;
  backdrop-filter: blur(2px);
}
.photo-viewer-prev { left: -64px; }
.photo-viewer-next { right: -64px; }
.photo-viewer-close {
  top: -52px;
  right: 0;
  transform: none;
  font-size: 22px;
}
.photo-viewer-close:hover,
.photo-viewer-prev:hover,
.photo-viewer-next:hover {
  background: rgba(255,255,255,0.22);
}

/* Lightbox caption */
.photo-viewer-caption {
  margin-top: 8px;
  text-align: center;
  color: #ccc;
  font-size: 0.95em;
  max-width: 92vw;
}
</style>
</head>
<body>

<header>
  <div class="fixed-canvas">
    <div class="wrap" id="app">
      <a href="index.html" class="index-logo-link">
        <img src="./image/logo2.svg" alt="Pknow Your Religion Logo" class="main-logo"/>
      </a>
      <div style="height:20px"></div>
      <img src="./image/relihiyon.svg" class="logo"/>
      <p class="disclaimer">
        Disclaimer: some data may not be 100% accurate and I would appreciate it if you give me insights. <br> Email me at tmdanao@up.edu.ph
      </p>
      <div class="header-controls" style="display:flex;flex-direction:column;align-items:center;">
        <!-- Filter bar: Search on its own row, then Category, Clear, Shuffle (left aligned) -->
        <div class="filter-bar" style="flex-direction:column;align-items:stretch;gap:8px;">
          <div style="display:flex;gap:10px;justify-content:center;width:100%;">
            <input id="searchBar" placeholder="Search..." style="flex:1"/>
          </div>
          <div style="display:flex;gap:10px;justify-content:flex-start;width:100%;">
            <div class="category-dropdown" id="categoryDropdown">
              <button class="category-dropdown-btn" id="categoryDropdownBtn" aria-expanded="false">
                <span id="categoryDropdownLabel">Category: All</span>
                <span style="margin-left:8px;">‚ñº</span>
              </button>
              <ul class="category-dropdown-list" id="categoryDropdownList"></ul>
            </div>
            <button id="clearBtn" class="clear-btn" type="button">Clear</button>
            <button id="shuffleBtn" class="button" type="button">Shuffle</button>
          </div>
        </div>
      </div>
      <button id="darkToggle" class="dark-toggle">Dark Mode</button>
    </div>
  </div>
</header>

<div id="grid"></div>

<div class="modal" id="modal">
  <div class="modal-content">
    <span class="modal-close" id="close">√ó</span>
    <div class="modal-header">
      <div class="modal-img-box" id="modalImgBox" style="display:none"></div>
      <div class="modal-header-info">
        <div class="modal-title" id="mTitle"></div>
        <div class="modal-meta" id="mClassification"></div>
        <div class="modal-meta" id="mFounder"></div>
        <div class="modal-meta" id="mPlace"></div>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" data-tab="info">Description</button>
      <button class="tab" data-tab="photos">Photos</button>
      <button class="tab" data-tab="videos">Videos</button>
      <!-- Added References tab -->
      <button class="tab" data-tab="references">Footnotes and References</button>
    </div>
    <div class="panel active" id="info"></div>
    <div class="panel" id="photos"></div>
    <div class="panel" id="videos"></div>
    <!-- Added References panel -->
    <div class="panel" id="references"></div>
  </div>
</div>

<!-- Add invisible footer spacer for photo preview hover -->
<div style="height:60px;width:100%"></div>

<!-- Simple photo viewer (lightbox) -->
<div class="photo-viewer" id="photoViewer">
  <div class="photo-viewer-content">
    <img class="photo-viewer-img" alt="Photo"/>
    <button class="photo-viewer-close" title="Close">√ó</button>
    <button class="photo-viewer-prev" title="Previous">‚Äπ</button>
    <button class="photo-viewer-next" title="Next">‚Ä∫</button>
    <div class="photo-viewer-caption"></div>
  </div>
</div>

<script>
const DATA = [
  {
    name:"Iglesia Watawat ng Lahi",
    classification: "Socio-folk Religious Movement, Rizalista Variant",
    founder: "",
    place: " Lecheria Hill in Calamba, Laguna",
    origin:"",
    description:"",
    summary: "",
    history:"",
    coreBeliefs: "",
    practices: "",
    controversies: "",
    orgStructure: "",
    membership: "",
    relationship: "",
    status: "",
    references: ['https://www.facebook.com/photo.php?fbid=117618116603304&id=107718370926612&set=a.107736270924822'],
    image:"image2/watawat.jpg",
    photos: [
      { photo: "image2/rizal.png", caption: "bahoasdbausdbsa" },
      { photo: "image2/watawat.jpg", caption: "bahoasdbausdbsa" },
    ],
    videos: [
      "https://www.youtube.com/watch?v=8WN4pN90L-I"
    ],
    highlights: [
    { term: "socio-folk religious movement", url: "https://en.wikipedia.org/wiki/Indigenous_religion" },
       { term: "", url: "" },
    ]
  },
  {
    name:"Philippine Benevolent Missionaries Association",
    classification: "",
    founder: "",
    place: "",
    origin:"",
    description:"",
    summary: "",
    history:"",
    coreBeliefs: "",
    practices: "",
    controversies: "",
    orgStructure: "",
    membership: "",
    relationship: "",
    status: "",
    image:"image2/ruben2.png",
    references:'',
    photos: [
    { photo: "image2/rizal.png", caption: "bahoasdbausdbsa" },
        { photo: "image2/ecleo.jpg", caption: "Robin Ecleo Jr." },
    ],
    videos: [
      ""
    ],
    highlights: [
    { term: "", url: "" },
       { term: "", url: "" },
    ]
  },
  {
    name:"Rizalista Religious Movements",
    classification: "Folk Catholicism",
    founder: "",
    place: "",
    origin:"",
    description:"",
    summary: "",
    history:"",
    coreBeliefs: "",
    practices: "",
    controversies: "",
    orgStructure: "",
    membership: "",
    relationship: "",
    status: "",
    image:"image2/jose.jpg",
    references: ['https://www.facebook.com/VirgenDeLasMesas/posts/the-sacred-heart-and-jose-rizaltoday-19-june-2020-is-a-special-day-because-today/2558316911087935/'],
    photos: [
      "image2/.png",
      "image2/.png"
    ],
    videos: [
      ""
    ],
    highlights: [
    { term: "Folk Catholicism", url: "https://en.wikipedia.org/wiki/Folk_Catholicism" },
       { term: "", url: "" },
    ]
  },
  {
    name:"",
    classification: "",
    founder: "",
    place: "",
    origin:"",
    description:"",
    summary: "",
    history:"",
    coreBeliefs: "",
    practices: "",
    controversies: "",
    orgStructure: "",
    membership: "",
    relationship: "",
    status: "",
    image:"image2/.png",
    photos: [
      "image2/.png",
      "image2/.png"
    ],
    videos: [
      ""
    ],
    highlights: [
    { term: "", url: "" },
       { term: "", url: "" },
    ]
  },

];

const grid=document.getElementById('grid');
const modal=document.getElementById('modal');
const search=document.getElementById('searchBar');
const photoViewer = document.getElementById('photoViewer');

// --- Category Dropdown, Shuffle, Clear ---
const categoryDropdownBtn = document.getElementById('categoryDropdownBtn');
const categoryDropdownList = document.getElementById('categoryDropdownList');
const categoryDropdownLabel = document.getElementById('categoryDropdownLabel');
const shuffleBtn = document.getElementById('shuffleBtn');
const clearBtn = document.getElementById('clearBtn');

let selectedCategory = '';
let searchQuery = '';
let currentList = [...DATA];

// Get unique categories (classification)
function getCategories() {
  const cats = DATA.map(d => d.classification || 'Unclassified');
  return ['All', ...Array.from(new Set(cats))];
}

// Render dropdown list
function renderCategoryDropdown() {
  const cats = getCategories();
  categoryDropdownList.innerHTML = cats.map(cat =>
    `<li${selectedCategory === cat ? ' class="selected"' : ''} data-cat="${cat}">${cat}</li>`
  ).join('');
}
renderCategoryDropdown();

// Dropdown open/close logic
categoryDropdownBtn.onclick = function(e) {
  const expanded = categoryDropdownBtn.getAttribute('aria-expanded') === 'true';
  categoryDropdownBtn.setAttribute('aria-expanded', !expanded);
  categoryDropdownList.classList.toggle('open', !expanded);
};
document.addEventListener('mousedown', function(e) {
  if (!categoryDropdownBtn.contains(e.target) && !categoryDropdownList.contains(e.target)) {
    categoryDropdownBtn.setAttribute('aria-expanded', 'false');
    categoryDropdownList.classList.remove('open');
  }
});

// Category select logic
categoryDropdownList.onclick = function(e) {
  if (e.target.tagName === 'LI') {
    selectedCategory = e.target.dataset.cat === 'All' ? '' : e.target.dataset.cat;
    categoryDropdownLabel.textContent = 'Category: ' + (selectedCategory || 'All');
    categoryDropdownBtn.setAttribute('aria-expanded', 'false');
    categoryDropdownList.classList.remove('open');
    filterAndRender();
  }
};

// Shuffle logic
shuffleBtn.onclick = function() {
  // Fisher-Yates shuffle
  for (let i = currentList.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [currentList[i], currentList[j]] = [currentList[j], currentList[i]];
  }
  render(currentList);
};

// Clear logic
clearBtn.onclick = function() {
  search.value = '';
  searchQuery = '';
  selectedCategory = '';
  categoryDropdownLabel.textContent = 'Category: All';
  renderCategoryDropdown();
  filterAndRender();
};

// Filter and render logic
function filterAndRender() {
  searchQuery = search.value.toLowerCase();
  currentList = DATA.filter(d => {
    const matchCategory = !selectedCategory || (d.classification === selectedCategory);
    const matchSearch = !searchQuery || d.name.toLowerCase().includes(searchQuery);
    return matchCategory && matchSearch;
  });
  render(currentList);
}

function render(list){
  grid.innerHTML='';
  list.forEach(d=>{
    const c=document.createElement('div');
    c.className='card';
    c.innerHTML=`
      <div class="card-img">
        ${d.image
          ? `<img src="${d.image}" alt="${d.name}" style="width:100%;height:100%;border-radius:12px;object-fit:cover"/>
             <div class="img-preview"><img src="${d.image}" alt="Preview of ${d.name}"/></div>`
          : '<span>üñºÔ∏è</span>'}
      </div>
      <div class="card-content">
        <h2>${d.name}</h2>
        <small>${d.classification || d.origin || ''}</small>
        <p>${d.summary || d.description || ''}</p>
      </div>
    `;
    c.onclick=()=>openModal(d);
    grid.appendChild(c);
  });
}

// Utility: highlight terms in text using highlights array
function highlightTerms(text, highlights, footnoteIndexByUrl) {
  if (!highlights || !Array.isArray(highlights) || !text) return text;
  const sorted = [...highlights].filter(h => h && h.term && h.url)
                                .sort((a, b) => b.term.length - a.term.length);
  if (!sorted.length) return text;
  const termToUrl = {};
  const escaped = sorted.map(h => {
    termToUrl[h.term.toLowerCase()] = h.url;
    return h.term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  });
  const re = new RegExp(`\\b(${escaped.join('|')})\\b`, 'gi');
  return text.replace(re, match => {
    const url = termToUrl[match.toLowerCase()];
    const n = footnoteIndexByUrl && url ? footnoteIndexByUrl.get(url) : null;
    const linked = url
      ? `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color:#7cf; text-decoration:underline">${match}</a>`
      : match;
    const sup = n ? `<sup class="fn"><a href="#ref-${n}" class="fn-link" data-ref-index="${n}" title="See reference [${n}]">[${n}]</a></sup>` : '';
    return linked + sup;
  });
}

// Combine references from d.references and d.highlights
function getCombinedReferences(d) {
  const refs = [];
  // d.references can be a string, array of strings, or array of {label/url}/{term/url}
  if (d.references) {
    if (Array.isArray(d.references)) {
      d.references.forEach(r => {
        if (typeof r === 'string' && r.trim()) {
          refs.push({ label: r, url: r });
        } else if (r && typeof r === 'object' && r.url) {
          refs.push({ label: r.label || r.term || r.url, url: r.url });
        }
      });
    } else if (typeof d.references === 'string' && d.references.trim()) {
      refs.push({ label: d.references, url: d.references });
    }
  }
  // add highlight links
  if (Array.isArray(d.highlights)) {
    d.highlights.forEach(h => {
      if (h && h.url) refs.push({ label: h.term || h.url, url: h.url });
    });
  }
  // dedupe by URL
  const seen = new Set();
  return refs.filter(r => {
    if (!r.url) return false;
    if (seen.has(r.url)) return false;
    seen.add(r.url);
    return true;
  });
}

let __modalImageLoadHandlers = new WeakMap();
let __modalObserver;

// Helper to force modal content to top
function resetModalScroll() {
	const mc = modal.querySelector('.modal-content');
	if (!mc) return;
	mc.scrollTop = 0;
	try { mc.scrollTo({ top: 0 }); } catch(e) {}
}

function openModal(d){
  // Modal header
  document.getElementById('mTitle').textContent = d.name || '';
  document.getElementById('mClassification').innerHTML = d.classification ? `<span><b>Classification:</b> ${d.classification}</span>` : '';
  document.getElementById('mFounder').innerHTML = d.founder ? `<span><b>Founder:</b> ${d.founder}</span>` : '';
  document.getElementById('mPlace').innerHTML = d.place ? `<span><b>Place Practiced:</b> ${d.place}</span>` : '';

  // Show image in modal with preview on hover
  const imgBox = document.getElementById('modalImgBox');
  if(d.image){
    imgBox.innerHTML = `
      <img src="${d.image}" alt="${d.name}"/>
      <div class="img-preview"><img src="${d.image}" alt="Preview of ${d.name}"/></div>
    `;
    imgBox.style.display = '';
  } else {
    imgBox.innerHTML = '<span style="font-size:48px;color:#888">üñºÔ∏è</span>';
    imgBox.style.display = '';
  }

  // Build combined references and footnote map once
  const combinedRefs = getCombinedReferences(d);
  const footnoteIndexByUrl = new Map(combinedRefs.map((r,i) => [r.url, i+1]));

  // Description tab with subtopics ‚Äî inline footnote numbers next to linked terms
  const infoPanel = document.getElementById('info');
  infoPanel.innerHTML = `
    <div class="desc-section"><h3>Summary</h3><p>${highlightTerms(d.summary || d.description || 'No data available.', d.highlights, footnoteIndexByUrl)}</p></div>
    <div class="desc-section"><h3>Founder</h3><p>${highlightTerms(d.founder || 'No data available.', d.highlights, footnoteIndexByUrl)}</p></div>
    <div class="desc-section"><h3>History</h3><p>${highlightTerms(d.history || 'No data available.', d.highlights, footnoteIndexByUrl)}</p></div>
    <div class="desc-section"><h3>Core Beliefs and Teachings</h3><p>${highlightTerms(d.coreBeliefs || 'No data available.', d.highlights, footnoteIndexByUrl)}</p></div>
    <div class="desc-section"><h3>Practices and Ritual</h3><p>${highlightTerms(d.practices || 'No data available.', d.highlights, footnoteIndexByUrl)}</p></div>
    <div class="desc-section"><h3>Controversies</h3><p>${highlightTerms(d.controversies || 'No data available.', d.highlights, footnoteIndexByUrl)}</p></div>
    <div class="desc-section"><h3>Organizational Structure</h3><p>${highlightTerms(d.orgStructure || 'No data available.', d.highlights, footnoteIndexByUrl)}</p></div>
    <div class="desc-section"><h3>Estimated Membership & Reach</h3><p>${highlightTerms(d.membership || 'No data available.', d.highlights, footnoteIndexByUrl)}</p></div>
    <div class="desc-section"><h3>Relationship with Society</h3><p>${highlightTerms(d.relationship || 'No data available.', d.highlights, footnoteIndexByUrl)}</p></div>
    <div class="desc-section"><h3>Current Status</h3><p>${highlightTerms(d.status || 'No data available.', d.highlights, footnoteIndexByUrl)}</p></div>
  `;

  // Photos tab
  const photosPanel = document.getElementById('photos');
  const normalizedPhotos = normalizePhotos(d.photos);
  if (normalizedPhotos.length) {
    photosPanel.innerHTML = `<div class="photo-gallery">${
      normalizedPhotos.map((p,i) => `
        <div class="photo-item">
          <img src="${p.url}" alt="${p.caption ? p.caption : 'photo of ' + (d.name || '')}" data-index="${i}"/>
          ${p.caption ? `<div class="photo-caption">${p.caption}</div>` : ''}
        </div>
      `).join('')
    }</div>`;
  } else {
    photosPanel.innerHTML = '<div style="opacity:.7">No photos available.</div>';
  }

  // Make photos clickable to open viewer
  photosPanel.onclick = function(e) {
    const img = e.target.closest('img');
    if (!img) return;
    const idx = Number(img.getAttribute('data-index')) || 0;
    openPhotoViewer(normalizedPhotos, idx);
  };

  // Videos tab
  const videosPanel = document.getElementById('videos');
  if (d.videos && d.videos.length) {
    videosPanel.innerHTML = `<div class="video-gallery">${d.videos.map(url =>
      `<iframe src="${url}" frameborder="0" allowfullscreen></iframe>`).join('')}</div>`;
  } else {
    videosPanel.innerHTML = '<div style="opacity:.7">No videos available.</div>';
  }

  // References tab (combined from highlights + d.references), with anchors for inline footnote jumps
  const refsPanel = document.getElementById('references');
  if (combinedRefs.length) {
    refsPanel.innerHTML = `
      <ul class="references-list">
        ${combinedRefs.map((r,i)=>`<li id="ref-${i+1}">[${i+1}] <a href="${r.url}" target="_blank" rel="noopener noreferrer">${r.label}</a></li>`).join('')}
      </ul>`;
  } else {
    refsPanel.innerHTML = '<div style="opacity:.7">No references available.</div>';
  }

  // Set Description as default tab
  document.querySelectorAll('.tab').forEach((b,i)=> {
    if(i===0) b.classList.add('active');
    else b.classList.remove('active');
  });
  document.querySelectorAll('.panel').forEach((p,i)=> {
    if(i===0) p.classList.add('active');
    else p.classList.remove('active');
  });

  resetModalScroll();
  modal.querySelectorAll('.modal-content img').forEach(img => {
    const handler = () => resetModalScroll();
    img.addEventListener('load', handler);
    __modalImageLoadHandlers.set(img, handler);
  });
  if (!__modalObserver) {
    const mc = modal.querySelector('.modal-content');
    if (mc) {
      __modalObserver = new MutationObserver(() => {
        requestAnimationFrame(() => setTimeout(resetModalScroll, 0));
      });
      __modalObserver.observe(mc, { childList: true, subtree: true, attributes: true });
    }
  }
  modal.classList.remove('closing');
  modal.classList.add('open');
  setTimeout(resetModalScroll, 50);
  setTimeout(resetModalScroll, 250);
}

// Close modal function (remains unchanged)
function closeModal() {
	modal.classList.remove('open');
	modal.classList.remove('closing');
	modal.style.display = '';

	// reset scroll when closed
	resetModalScroll();

	// remove any image load handlers to avoid leaks
	modal.querySelectorAll('.modal-content img').forEach(img => {
		const handler = __modalImageLoadHandlers.get(img);
		if (handler) {
			img.removeEventListener('load', handler);
			__modalImageLoadHandlers.delete(img);
		}
	});
}

// Close modal when clicking outside modal-content
modal.addEventListener('mousedown', function(e) {
  if (e.target === modal) {
    closeModal();
  }
});

document.querySelectorAll('.tab').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
  }
});

// Search logic
search.oninput = filterAndRender;

// Initial render
filterAndRender();

// --- Dark mode memory ---
function setDarkBackground() {
  const url = "image2/night.jpg";
  document.body.style.backgroundImage = `url("${url}")`;
  document.body.style.backgroundRepeat = 'no-repeat';
  document.body.style.backgroundPosition = 'center center';
  document.body.style.backgroundAttachment = 'fixed';
  document.body.style.backgroundSize = 'contain';
  document.body.style.backgroundColor = '#000';
}

function setLightBackground() {
  // Use the same background as light mode
  const url = "image2/cat3.jpg";
  document.body.style.backgroundImage = `url("${url}")`;
  document.body.style.backgroundRepeat = 'no-repeat';
  document.body.style.backgroundPosition = 'center center';
  document.body.style.backgroundAttachment = 'fixed';
  document.body.style.backgroundSize = 'contain';
  document.body.style.backgroundColor = '#000';
}

// --- Dark mode memory & initial background setup ---
function applyDarkModeSetting() {
  const isDark = localStorage.getItem('darkMode') === 'true';
  document.body.classList.toggle('dark', isDark);
  document.documentElement.classList.toggle('dark', isDark);
  document.getElementById('darkToggle').textContent = isDark ? 'Light Mode' : 'Dark Mode';
  if (isDark) setDarkBackground();
  else setLightBackground();
}
applyDarkModeSetting();

document.getElementById('darkToggle').onclick = function() {
  document.body.classList.toggle('dark');
  document.documentElement.classList.toggle('dark');
  const isDark = document.body.classList.contains('dark');
  localStorage.setItem('darkMode', isDark ? 'true' : 'false');
  document.getElementById('darkToggle').textContent = isDark ? 'Light Mode' : 'Dark Mode';
  if (isDark) setDarkBackground();
  else setLightBackground();
};

// Close modal with Escape key (uses same closeModal so scroll resets)
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && modal.classList.contains('open')) {
    closeModal();
  }
});

// Jump to References tab when clicking inline footnote numbers
modal.addEventListener('click', function(e) {
  const link = e.target.closest('.fn-link');
  if (!link) return;
  e.preventDefault();
  const idx = link.dataset.refIndex;
  // activate References tab
  document.querySelectorAll('.tab').forEach(b=>{
    b.classList.toggle('active', b.dataset.tab === 'references');
  });
  document.querySelectorAll('.panel').forEach(p=>{
    p.classList.toggle('active', p.id === 'references');
  });
  // scroll to the reference item
  const target = document.getElementById(`ref-${idx}`);
  if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
});

// Normalize photos: accept string or { url|photo|src, caption|description }
function normalizePhotos(photos) {
  if (!Array.isArray(photos)) return [];
  return photos
    .map(p => {
      const url = typeof p === 'string' ? p : (p && (p.url || p.photo || p.src));
      const caption = (p && typeof p === 'object') ? (p.caption || p.description || '') : '';
      if (typeof url !== 'string' || !url.trim()) return null;
      return { url, caption };
    })
    .filter(Boolean);
}

// Simple photo viewer (lightbox)
let __photoViewer, __pvImg, __pvPrev, __pvNext, __pvClose, __pvCaption;
let __pvPhotos = [], __pvIndex = 0;

function ensurePhotoViewer() {
  if (__photoViewer) return;
  __photoViewer = document.createElement('div');
  __photoViewer.className = 'photo-viewer';
  __photoViewer.innerHTML = `
    <div class="photo-viewer-content">
      <img class="photo-viewer-img" alt="Photo"/>
      <button class="photo-viewer-close" title="Close">√ó</button>
      <button class="photo-viewer-prev" title="Previous">‚Äπ</button>
      <button class="photo-viewer-next" title="Next">‚Ä∫</button>
      <div class="photo-viewer-caption"></div>
    </div>
  `;
  document.body.appendChild(__photoViewer);
  __pvImg = __photoViewer.querySelector('.photo-viewer-img');
  __pvPrev = __photoViewer.querySelector('.photo-viewer-prev');
  __pvNext = __photoViewer.querySelector('.photo-viewer-next');
  __pvClose = __photoViewer.querySelector('.photo-viewer-close');
  __pvCaption = __photoViewer.querySelector('.photo-viewer-caption');

  __pvClose.onclick = closePhotoViewer;
  __pvPrev.onclick = () => navPhoto(-1);
  __pvNext.onclick = () => navPhoto(1);

  // Click backdrop to close
  __photoViewer.addEventListener('mousedown', (e) => {
    if (e.target === __photoViewer) closePhotoViewer();
  });

  // Keyboard nav when viewer is open
  document.addEventListener('keydown', (e) => {
    if (!__photoViewer.classList.contains('open')) return;
    if (e.key === 'Escape') { closePhotoViewer(); e.preventDefault(); }
    else if (e.key === 'ArrowLeft') { navPhoto(-1); e.preventDefault(); }
    else if (e.key === 'ArrowRight') { navPhoto(1); e.preventDefault(); }
  });
}

function openPhotoViewer(photos, index = 0) {
  ensurePhotoViewer();
  __pvPhotos = normalizePhotos(photos);
  if (!__pvPhotos.length) return;
  __pvIndex = Math.max(0, Math.min(index, __pvPhotos.length - 1));
  updatePhotoViewer();
  __photoViewer.classList.add('open');
}

function closePhotoViewer() {
  if (__photoViewer) __photoViewer.classList.remove('open');
}

function navPhoto(delta) {
  if (!__pvPhotos.length) return;
  __pvIndex = (__pvIndex + delta + __pvPhotos.length) % __pvPhotos.length;
  updatePhotoViewer();
}

function updatePhotoViewer() {
  const item = __pvPhotos[__pvIndex];
  __pvImg.src = item.url;
  __pvImg.alt = item.caption || `Photo ${__pvIndex + 1} of ${__pvPhotos.length}`;
  if (__pvCaption) __pvCaption.textContent = item.caption || '';
}
</script>

</body>
</html>
